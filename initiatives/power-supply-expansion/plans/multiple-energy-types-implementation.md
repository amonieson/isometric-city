# Multiple Energy Types Implementation Plan

## Executive Summary

This document outlines a plan to implement multiple energy types (solar, wind, and potentially others) in isometric-city, based on the energy system architecture from lincity-ng. The plan maintains compatibility with the existing power system while adding new renewable energy sources with distinct characteristics.

### ✅ Key Decisions Confirmed

1. **Different Coverages**: Solar (8 tiles), Wind (10 tiles), Power Plant (15 tiles)
2. **Power Stacking**: Boolean OR coverage (keep simple, same as current system)
3. **Terrain Requirements**: Wind turbines require coastal placement (water adjacency) - no elevation system exists
4. **Day/Night**: ~~Solar panels only work during day (hour 6-20), no output at night~~ **REMOVED** - Solar panels work 24/7 (battery system assumed)
5. **Weather**: No weather system exists - confirmed via codebase check
6. **Pollution**: Renewables have negative pollution (-5) vs power plant (+30)
7. **Cost Structure**: Higher initial cost (4,000-4,500) but lower maintenance (50-75/month) vs power plant (3,000 initial, 150/month)
8. **Visual**: Same color overlay for all power sources
9. **Buildings**: Separate buildings, smaller (1x1), require more of them
10. **System**: Keep radius-based system (no power grid needed)
11. **Integration**: ~~Integrate with existing day/night cycle system~~ **REMOVED** - No day/night variation needed

---

## 0. Codebase Verification

### 0.1 Day/Night System ✅
**Status**: Confirmed to exist
- **Location**: `src/lib/simulation.ts:1904-1909`, `src/context/GameContext.tsx:844-850`
- **Implementation**: Hour 0-23, calculated from game ticks
- **Night Definition**: `hour >= 20 || hour < 6` (most common pattern in codebase)
- **Day Definition**: `hour >= 6 && hour < 20`
- **Usage**: Used in multiple systems (aircraft, boats, effects, rendering)
- **Integration Point**: `state.hour` available in `calculateServiceCoverage()` via `simulateTick()`

### 0.2 Weather System ❌
**Status**: Does not exist
- **Verification**: Searched codebase for "weather", "Weather", "WEATHER"
- **Result**: Only found in planning documents, no actual weather system
- **Conclusion**: No weather-based variation for wind turbines

### 0.3 Elevation/Terrain System ❌
**Status**: Does not exist
- **Verification**: Searched for "elevation", "Elevation", "terrainType"
- **Result**: No elevation system found
- **Terrain Types**: Only basic types exist (grass, water, road, etc.)
- **Conclusion**: Wind turbine coastal requirement must use water adjacency only

### 0.4 Water Adjacency System ✅
**Status**: Confirmed to exist
- **Location**: `src/lib/simulation.ts:537-628`
- **Functions Available**:
  - `isNearWater(grid, x, y, size)` - checks 5x5 area for water
  - `getWaterAdjacency(grid, x, y, width, height, gridSize)` - checks building footprint edges
  - `requiresWaterAdjacency(buildingType)` - checks if building type needs water
- **Usage**: Currently used for `marina_docks_small` and `pier_large`
- **Integration Point**: Can use same pattern for wind turbines

---

## 1. Analysis of lincity-ng Energy System

### 1.1 Key Concepts from lincity-ng

**Power Generation Architecture:**
- **High Voltage (HIVOLT)**: Generated by power plants (solar, wind, coal)
- **Power Lines**: Transport high voltage electricity across the map
- **Substations**: Convert high voltage to low voltage (LOVOLT) for local distribution
- **Commodity System**: Power is treated as a commodity that flows through the network

**Power Source Characteristics:**
- **Solar Power**: 
  - Generates HIVOLT based on available labor and technology level
  - Output scales with technology: `POWERS_SOLAR_OUTPUT + (tech * POWERS_SOLAR_OUTPUT / MAX_TECH_LEVEL)`
  - Requires labor to operate
  - No fuel consumption
  - No pollution

- **Wind Power**:
  - Similar to solar: generates HIVOLT with labor and technology scaling
  - Has animation system (rotating blades)
  - No fuel consumption
  - No pollution

- **Coal Power**:
  - Consumes coal and labor to generate HIVOLT
  - Produces pollution
  - Higher base output than renewables
  - Requires fuel supply chain

**Distribution System:**
- Power lines consume HIVOLT (1 unit) to transport electricity
- Substations convert HIVOLT to LOVOLT (1:2 ratio)
- Buildings consume LOVOLT for operation

### 1.2 Differences from isometric-city

**lincity-ng:**
- Commodity-based system (power flows as resources)
- Network-based distribution (power lines + substations)
- Technology-dependent output scaling
- Labor requirements for operation

**isometric-city (current):**
- Boolean coverage system (tile has power or doesn't)
- Radius-based distribution (circular coverage from power plants)
- No technology scaling
- No labor requirements
- No fuel consumption

---

## 2. Proposed Implementation Strategy

### 2.1 Hybrid Approach

We'll implement a **hybrid system** that:
1. **Maintains backward compatibility** with existing power plants
2. **Adds new energy types** that work within the existing coverage system
3. **Allows for future expansion** to a commodity-based system if desired

### 2.2 Design Decisions

**Decision 1: Coverage vs. Commodity System**
- **Recommendation**: Start with coverage system (simpler, maintains compatibility)
- **Rationale**: 
  - Existing codebase uses coverage
  - Easier to implement and test
  - Can migrate to commodity system later if needed
  - Matches current water system architecture

**Decision 2: Power Source Characteristics** ✅ **CONFIRMED**
- **Solar Panels**: 
  - Smaller range (8-10 tiles) vs power plant (15 tiles) - **Different coverage confirmed**
  - Higher initial cost (4,000 vs 3,000) but lower maintenance (50/month vs 150/month)
  - Negative pollution (-5) - **Slightly negative environmental impact**
  - Day/night variation: **Only works during day (hour 6-20), no output at night**
  - 1x1 tile size (can be placed in residential/commercial zones)
  - **Smaller placement, requires more of them to match power plant coverage**

- **Wind Turbines**:
  - Medium range (10-12 tiles) - **Different coverage confirmed**
  - Higher initial cost (4,500) but lower maintenance (75/month vs 150/month)
  - Negative pollution (-5) - **Slightly negative environmental impact**
  - Consistent output (no weather system exists)
  - 1x1 tile size
  - **Requires coastal placement (water adjacency)** - **No elevation system exists**
  - **Smaller placement, requires more of them to match power plant coverage**

- **Power Plant (existing)**:
  - Large range (15 tiles)
  - Initial cost (3,000)
  - High maintenance (150/month)
  - High pollution (30)
  - Consistent output
  - 2x2 tile size

**Decision 3: Power Stacking** ✅ **CONFIRMED**
- **Decision**: Allow overlapping coverage (boolean OR) - **Keep simple, same as current system**
- **Rationale**: 
  - Matches current system behavior
  - Simpler to implement
  - No capacity system needed for now

**Decision 4: Day/Night Variation** ✅ **UPDATED**
- **Decision**: **Solar panels work 24/7 (battery system assumed) - no day/night variation**
- **Rationale**:
  - Simplifies implementation and gameplay
  - Eliminates negative impacts (50% population/jobs loss at night)
  - Avoids player confusion and frustration
  - Battery system is assumed but not implemented (too complex)

---

## 3. Implementation Steps

### Phase 1: Type System Extensions

#### 3.1 Add New Building Types

**File**: `src/types/game.ts`

```typescript
// Add to BuildingType union:
| 'solar_panel'
| 'wind_turbine'
```

**Tasks:**
- [ ] Add types to `BuildingType` union
- [ ] Add building metadata to `BUILDING_INFO`
- [ ] Add building stats to `BUILDING_STATS`
- [ ] Add building dimensions to `getBuildingSize()` in `simulation.ts`

#### 3.2 Building Metadata

**Solar Panel:**
- Name: "Solar Panel"
- Cost: 4,000 (higher initial cost)
- Size: 1x1
- Description: "Generate clean electricity from sunlight"
- Max Population: 0
- Max Jobs: 2 (maintenance)
- Pollution: -5 (slightly negative environmental impact)
- Land Value: +5 (renewable energy bonus)
- Maintenance: 50/month (lower than power plant)

**Wind Turbine:**
- Name: "Wind Turbine"
- Cost: 4,500 (higher initial cost)
- Size: 1x1
- Description: "Generate clean electricity from wind (requires coastal placement)"
- Max Population: 0
- Max Jobs: 3 (maintenance)
- Pollution: -5 (slightly negative environmental impact)
- Land Value: -5 (visual/noise impact)
- Maintenance: 75/month (lower than power plant)
- **Placement Requirement**: Must be adjacent to water (coastal)

---

### Phase 2: Service Coverage System

#### 3.3 Extend Service Configuration

**File**: `src/lib/simulation.ts`

**Add to `SERVICE_CONFIG`:**
```typescript
solar_panel: { range: 8, rangeSquared: 64 },  // Smaller range than power plant
wind_turbine: { range: 10, rangeSquared: 100 }, // Medium range, smaller than power plant
```

**Add to `SERVICE_BUILDING_TYPES`:**
```typescript
const SERVICE_BUILDING_TYPES = new Set([
  'police_station', 'fire_station', 'hospital', 'school', 'university',
  'power_plant', 'solar_panel', 'wind_turbine', 'water_tower'
]);
```

#### 3.4 Update Coverage Calculation

**File**: `src/lib/simulation.ts` - `calculateServiceCoverage()`

**Power coverage logic (all power sources work 24/7):**
```typescript
// All power sources work 24/7 (solar assumes battery system)
if (type === 'power_plant' || type === 'solar_panel' || type === 'wind_turbine') {
  for (let ny = minY; ny <= maxY; ny++) {
    for (let nx = minX; nx <= maxX; nx++) {
      const dx = nx - x;
      const dy = ny - y;
      if (dx * dx + dy * dy <= rangeSquared) {
        services.power[ny][nx] = true;
      }
    }
  }
}
```

**Note**: Function signature can remain simple - no hour parameter needed

**Tasks:**
- [ ] Update `SERVICE_CONFIG` with new power sources
- [ ] Update `SERVICE_BUILDING_TYPES` set
- [ ] Modify power coverage calculation to handle all power types
- [ ] Test coverage overlap behavior

---

### Phase 3: ~~Day/Night Variation~~ **REMOVED - Battery System Assumed**

#### 3.5 Solar Panel Day/Night Logic

**File**: `src/lib/simulation.ts` - `calculateServiceCoverage()`

**Add day/night check for solar panels:**
```typescript
if (type === 'solar_panel') {
  // Check if it's day time (hour 6-20, night is hour >= 20 || hour < 6)
  const isDay = state.hour >= 6 && state.hour < 20;
  
  // Solar panels only work during day - no power at night
  if (!isDay) {
    continue; // Skip this solar panel, no power generation at night
  }
  
  // Normal coverage during day
  for (let ny = minY; ny <= maxY; ny++) {
    for (let nx = minX; nx <= maxX; nx++) {
      const dx = nx - x;
      const dy = ny - y;
      if (dx * dx + dy * dy <= rangeSquared) {
        services.power[ny][nx] = true;
      }
    }
  }
}
```

**Tasks:**
- [ ] Add day/night check to solar panel coverage (hour 6-20 = day, else no power)
- [ ] Test solar panel behavior during day/night cycles
- [ ] Verify no power output at night (hour >= 20 || hour < 6)

---

### Phase 4: Budget System

#### 3.6 Update Budget Calculations

**File**: `src/lib/simulation.ts` - `updateBudgetCosts()`

**Add power source counting:**
```typescript
let powerCount = 0;
let solarCount = 0;
let windCount = 0;

// In the counting loop:
case 'power_plant': powerCount++; break;
case 'solar_panel': solarCount++; break;
case 'wind_turbine': windCount++; break;

// Update budget costs:
newBudget.power.cost = powerCount * 150 + solarCount * 50 + windCount * 75;
```

**Rationale:** ✅ **CONFIRMED**
- Power plants: 150/month (high maintenance)
- Solar panels: 50/month (lower maintenance - higher initial cost but lower monthly)
- Wind turbines: 75/month (lower maintenance - higher initial cost but lower monthly)

**Tasks:**
- [ ] Add counting for new power sources
- [ ] Update budget cost calculation
- [ ] Test budget panel display

---

### Phase 5: Visual Representation

#### 3.7 Building Renderers

**File**: `src/components/buildings/IsometricBuildings.tsx`

**Create Solar Panel Component:**
```typescript
const SolarPanel = ({ size }: { size: { width: number; height: number } }) => {
  return (
    <g>
      {/* Base platform */}
      <polygon
        points={`${size.width * 0.1},${size.height * 0.9} ${size.width * 0.9},${size.height * 0.9} ${size.width * 0.8},${size.height * 0.7} ${size.width * 0.2},${size.height * 0.7}`}
        fill="#2a2a2a"
      />
      {/* Solar panel array */}
      <rect
        x={size.width * 0.2}
        y={size.height * 0.5}
        width={size.width * 0.6}
        height={size.height * 0.2}
        fill="#1a3a5a"
        stroke="#0a2a4a"
        strokeWidth="0.5"
      />
      {/* Panel grid lines */}
      {[0, 1, 2].map(i => (
        <line
          key={i}
          x1={size.width * (0.2 + i * 0.2)}
          y1={size.height * 0.5}
          x2={size.width * (0.2 + i * 0.2)}
          y2={size.height * 0.7}
          stroke="#0a2a4a"
          strokeWidth="0.3"
        />
      ))}
    </g>
  );
};
```

**Create Wind Turbine Component:**
```typescript
const WindTurbine = ({ size }: { size: { width: number; height: number } }) => {
  return (
    <g>
      {/* Tower */}
      <rect
        x={size.width * 0.45}
        y={size.height * 0.6}
        width={size.width * 0.1}
        height={size.height * 0.3}
        fill="#666"
      />
      {/* Nacelle */}
      <ellipse
        cx={size.width * 0.5}
        cy={size.height * 0.5}
        rx={size.width * 0.15}
        ry={size.height * 0.08}
        fill="#888"
      />
      {/* Blades (simplified) */}
      {[0, 120, 240].map((angle, i) => (
        <line
          key={i}
          x1={size.width * 0.5}
          y1={size.height * 0.5}
          x2={size.width * (0.5 + 0.25 * Math.cos((angle * Math.PI) / 180))}
          y2={size.height * (0.5 + 0.25 * Math.sin((angle * Math.PI) / 180))}
          stroke="#aaa"
          strokeWidth="1"
        />
      ))}
    </g>
  );
};
```

**Add to building renderer switch:**
```typescript
case 'solar_panel':
  return <SolarPanel size={size} />;
case 'wind_turbine':
  return <WindTurbine size={size} />;
```

**Tasks:**
- [ ] Create `SolarPanel` SVG component
- [ ] Create `WindTurbine` SVG component
- [ ] Add to building renderer switch
- [ ] Test visual rendering
- [ ] Add sprite support (optional)

---

### Phase 6: UI Integration

#### 3.8 Tool Integration

**File**: `src/components/game/Sidebar.tsx` or toolbar component

**Add new tools:**
- [ ] Add "Solar Panel" tool button
- [ ] Add "Wind Turbine" tool button
- [ ] Update tool selection logic
- [ ] Add tool icons/graphics

#### 3.9 Building Info Panel

**File**: `src/components/game/panels/TileInfoPanel.tsx`

**Update building info display:**
- [ ] Show power source type
- [ ] Display power range/coverage
- [ ] Show pollution impact
- [ ] Display maintenance costs

---

### Phase 7: Placement Rules

#### 3.10 Building Placement

**File**: `src/lib/simulation.ts` - `canPlaceBuilding()` or similar

**Solar Panel Placement:**
- Can be placed on any non-water tile
- Can be placed in residential/commercial/industrial zones
- No special adjacency requirements
- **1x1 size - smaller placement, requires more of them**

**Wind Turbine Placement:**
- **Must be adjacent to water (coastal placement)** - uses `getWaterAdjacency()` or `isNearWater()`
- Can be placed in any zone
- **1x1 size - smaller placement, requires more of them**
- **No elevation system exists** - coastal requirement is based on water adjacency only

**Tasks:**
- [ ] Implement placement validation for wind turbines (water adjacency check)
- [ ] Use `getWaterAdjacency()` or `isNearWater()` for wind turbine placement
- [ ] Add placement feedback (visual indicators for invalid wind turbine placement)
- [ ] Test placement edge cases (coastal boundaries, water tiles)

---

## 4. Future Enhancements (Post-MVP)

### 4.1 Commodity-Based System

If we want to move closer to lincity-ng's system:

**Power Network:**
- Power lines to transport electricity
- Substations to convert high/low voltage
- Power capacity limits
- Power consumption per building type

**Benefits:**
- More realistic power distribution
- Strategic power grid planning
- Power shortages/blackouts
- More complex gameplay

**Challenges:**
- Significant refactoring
- More complex simulation
- Performance considerations

### 4.2 Technology Scaling

**Implementation:**
- Add technology level to game state
- Scale power output based on tech level
- Research system to unlock improvements

**Example:**
```typescript
const baseOutput = 100;
const techMultiplier = 1 + (techLevel / MAX_TECH_LEVEL);
const actualOutput = baseOutput * techMultiplier;
```

### 4.3 Weather System

**Status**: ❌ **No weather system exists in current codebase**

**Future Consideration:**
- Wind Turbine Variation: Variable output based on wind strength (if weather system added)
- Solar Panel Variation: Cloud cover affects output (if weather system added)
- **Current Implementation**: No weather-based variation

### 4.4 Additional Power Sources

**Potential Additions:**
- Hydroelectric (requires water)
- Nuclear (high output, high cost, waste)
- Geothermal (location-dependent)
- Biomass (requires organic waste)

---

## 5. Testing Strategy

### 5.1 Unit Tests

- [ ] Test service coverage calculation with multiple power sources
- [x] Solar panels work 24/7 (battery system assumed)
- [ ] Test budget cost calculations
- [ ] Test placement validation

### 5.2 Integration Tests

- [ ] Test power coverage with overlapping sources
- [ ] Test building requirements (power dependency)
- [ ] Test save/load with new building types
- [ ] Test visual rendering

### 5.3 Gameplay Tests

- [ ] Test early game with solar panels (cheaper alternative)
- [ ] Test mid-game with mixed power sources
- [ ] Test late game with renewable energy focus
- [ ] Test day/night cycle impact

---

## 6. Migration Path

### 6.1 Backward Compatibility

**Existing Saves:**
- Existing power plants continue to work
- No breaking changes to save format
- New buildings are optional additions

### 6.2 Gradual Rollout

1. **Phase 1**: Add solar panels only
2. **Phase 2**: Add wind turbines
3. ~~**Phase 3**: Add day/night variation~~ **REMOVED**
4. **Phase 4**: Add advanced features (weather, tech scaling)

---

## 7. Design Decisions - RESOLVED ✅

1. **Power Capacity**: ✅ **Keep simple - boolean OR coverage, no capacity system**
   - Multiple power sources can overlap (same as current system)
   - Simpler is better for now

2. **Visual Feedback**: ✅ **Same color overlay - keep it simple**
   - All power sources use the same overlay color
   - No differentiation needed in visual feedback

3. **Balance**: ✅ **Confirmed values**
   - Solar: 4,000 initial, 50/month, range 8
   - Wind: 4,500 initial, 75/month, range 10
   - Power Plant: 3,000 initial, 150/month, range 15

4. **Placement Restrictions**: ✅ **Confirmed**
   - Wind turbines: **Require coastal placement (water adjacency)** - no elevation system exists
   - Solar panels: No special terrain requirements
   - Both: **Separate buildings, smaller (1x1), require more of them**

5. **Maintenance**: ✅ **Confirmed - lower monthly maintenance for renewables**
   - Higher initial cost but lower monthly costs
   - Power plants: 150/month
   - Solar: 50/month
   - Wind: 75/month

6. **Efficiency**: ✅ **No efficiency degradation - keep simple**

7. **Day/Night Integration**: ✅ **REMOVED** - Solar panels work 24/7
   - Battery system assumed but not implemented
   - No day/night variation needed

8. **Power Grid**: ✅ **Keep radius-based system - simpler is better**
   - No power lines or grid system needed
   - Maintains current circular coverage approach

9. **Integration**: ✅ **Integrate with existing systems**
   - Day/night cycle integration confirmed
   - No weather system exists (confirmed via codebase check)

---

## 8. File Changes Summary

### New Files
- None (all changes to existing files)

### Modified Files
1. `src/types/game.ts` - Add building types and metadata
2. `src/lib/simulation.ts` - Service coverage, budget, placement
3. `src/components/buildings/IsometricBuildings.tsx` - Visual renderers
4. `src/components/game/Sidebar.tsx` - Tool integration
5. `src/components/game/panels/TileInfoPanel.tsx` - Building info display

### Estimated Lines of Code
- Type definitions: ~50 lines
- Simulation logic: ~200 lines
- Visual components: ~150 lines
- UI integration: ~100 lines
- **Total: ~500 lines**

---

## 9. Timeline Estimate

- **Phase 1-2** (Type System + Service Coverage): 2-3 days
- ~~**Phase 3** (Day/Night): 1 day~~ **REMOVED**
- **Phase 4** (Budget): 0.5 days
- **Phase 5** (Visual): 2-3 days
- **Phase 6** (UI): 1-2 days
- **Phase 7** (Placement): 1 day
- **Testing & Polish**: 2-3 days

**Total: ~10-14 days** for full implementation

---

## 10. Success Criteria

- [ ] Solar panels and wind turbines can be placed
- [ ] Both provide power coverage to nearby buildings
- [ ] Budget system correctly calculates maintenance costs
- [ ] Visual rendering matches design
- [x] Solar panels work 24/7 (battery system assumed)
- [ ] No breaking changes to existing saves
- [ ] Performance impact is minimal (<5% simulation time)

---

## References

- lincity-ng source code analysis (via Driver MCP)
- Existing power plant implementation (`initiatives/power-supply-expansion/research/power-plant-implementation.md`)
- Current service coverage system (`src/lib/simulation.ts:863-951`)

